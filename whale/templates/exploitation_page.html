<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WHALE</title>
	<style>
		.header-container{
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 20px;
			width: 100%;
			box-sizing: border-box;
		}
		.button-container{
			display: flex;
			align-items: center;
		}
		.button-container button{
			background-color: #003087;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			margin-left: 10px;
			margin-right: 10px;
		}
		.button-container button:hover {
			background-color: #0085CA;
		}
		.page-title {
			margin: 0;
			font-size: 24 px;
			test-align: center;
			flex-grow: 1;
			position: absolute;
			left: 40%;
			width: 100%
		}
		.container{
			display: flex;
			aleign-items: center;
		}
		.flex-container{
			display: flex;
			justify-contnet: space-between;
			align-items: flex-start;
		}
		.map-container, form-container {
			flex: 1;
			margin: 10px;
			width: 45%;
		}
		.map{
			height: 500px;
			width: 100%;
			border: 1px solid #ccc;
		}
	</style>
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
	<div class="header-container">
		<div class="button-container">
			<form id="home-form" action="{% url 'landing_page' %}" method="POST" style="display: inline;">
				{% csrf_token %}
				<button type="submit">Home</button>
			</form>
		</div>
		
		<h1 class="page-title">Exploitation Page</h1>
		
		<div class="button-container">
			<form id="logout-form" action="{% url 'logout' %}" method="POST" style="display: inline;">
				{% csrf_token %}
				<button type="submit">Logout</button>
			</form>
		</div>
	</div>

	<div>
		<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
	</div>

	<!-- Body header -->
	{% if poi %}
		<h2>Record information</h2>
			<p><strong>Interesting Point ID:</strong> {{ poi.id }} </p>
			<p><strong>Catalog ID:</strong> {{ poi.catalog_id }} </p>
			<p><strong>Entity ID:</strong> {{ poi.entity_id }} </p>
			<p><strong>Vendor ID:</strong> {{ poi.vendor_id }} </p>
			<p><strong>Currently Classified Species:</strong> {{ poi.species }} </p>


	<div class="container">

		{% if error_message %}
		<div class="alert alert-warning">
			{{ error_message }}
		</div>
		{% endif %}

		<div id="osm-map" class="map"></div>
		<div id="gdal-map" class="map"></div>
		<div class="form-container">
			<h2>Record controls</h2
				<!-- Previous button form -->
				<div>
					<a href="{% url 'exploitation_page' %}?action=previous" class="btn btn-primary">Previous</a>
					<a href="{% url 'exploitation_page' %}?action=next" class="btn btn-primary">Next</a>
					<!--
					{% if previous_id %}
					<a href="{% url 'exploitation_page' %}?id={{ previous_id }}&catalog_id={{ species.catalog_id }}&vendor_id={{ species.vendor_id }}&entity_id={{ species.entity_id }}">
					<button onclick="console.log('Previous button clicked with ID:', {{ previous_id }}, 'Catalog:', {{ species.catalog_id }}, 'Vendor:', {{ species.vendor_id }}, 'Entity:', {{ species.entity_id }})">Previous</button>
					</a>
					{% endif %}

					{% if next_id %}
					<a href="{% url 'exploitation_page' %}?id={{ next_id }}&catalog_id={{ species.catalog_id }}&vendor_id={{ species.vendor_id }}&entity_id={{ species.entity_id }}">
					<button onclick="console.log('Next button clicked with ID:', {{ next_id }}, 'Catalog:', {{ species.catalog_id }}, 'Vendor:', {{ species.vendor_id }}, 'Entity:', {{ species.entity_id }})">Next</button>
					</a>
					{% endif %}
					-->
				</div>
		
			<h2>Record Classification Form</h2>
			<form method="post">
				{% csrf_token %}
				{{ poi_form.as_p }}
				<input type="hidden" name="form_type" value="species_form">
				<button type="submit">Submit Label Form</button>
			</form>
				
			{% else %}
				<h1>No record selected</h1>
				<p>Please begin reviewing the data...</p>
				<h2>POI Form</h2>
				<form method="post">
					{% csrf_token %}
					{{ poi_form.as_p }}
					<input type="hidden" name="form_type" value="poi_form">
					<button type="submit">Submit Label Form</button>
				</form>
				
			{% endif %}
		</div>
		
		<div class="controls">
			<label for="exposure">Brightness: </label><span id="exposure-value"></span>
				<input type="range" id="exposure" min="-0.5" max="0.5" step="0.1" value="0">
				<p></p>
			
			<label for="contrast">Contrast: </label><span id="contrast-value"></span>
				<input type="range" id="contrast" min="-0.5" max="0.5" step="0.1" value="0">
				<p></p>
			
			<label for="saturation">Saturation: </label><span id="saturation-value"></span>
				<input type="range" id="saturation" min="-0.5" max="0.5" step="0.1" value="0">
				<p></p>
		</div>
	</div>
	
	<script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.1.0/ol.css">
	<script src="https://cdn.jsdelivr.net/npm/ol@v10.1.0/dist/ol.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.0/proj4.js"></script>
	<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
	
<script>
    // Ensure variables are passed correctly
    const latitude = {{ latitude }}; //42.049081 //;
    const longitude = {{ longitude }};  //-70.183762 //;
    const cogUrl = "{{ cog_url }}";

    // Map Initialization
    window.onload = function() {
        // Initialize maps, points, and other layers here
        initializeMaps();
    };

    function initializeMaps() {
        // Re-initialize the maps based on the provided latitude, longitude, and COG URL
        const point = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([longitude, latitude])),
            name: 'Point of Interest',
        });

        const cogSource = new ol.source.GeoTIFF({ sources: [{ url: cogUrl }] });
        const baseLayer = new ol.layer.Tile({ source: new ol.source.OSM() });
        const vectorSource = new ol.source.Vector({ features: [point] });
        const vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                image: new ol.style.Icon({ src: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png', scale: 1 })
            }),
        });

		const variables = {
			exposure: 0,
			contrast: 0,
			saturation: 0,
		};

        // Initialize the COG image layer
        const cogLayer = new ol.layer.WebGLTile({
			style: {
				exposure: ['var', 'exposure'],
				contrast: ['var', 'contrast'],
				saturation: ['var', 'saturation'],
				variables: variables,
			},
            source: cogSource,
			attributions: 'GAIA',
        });

		// Variable handling
		let variable;
		for (variable in variables) {
			const name = variable;
			const element = document.getElementById(name);
			const value = variables[name];
			element.value = value.toString();
			document.getElementById(name + '-value').innerText = value.toFixed(2);
			element.addEventListener('input', function (event) {
				const value = parseFloat(event.target.value);
				document.getElementById(name + '-value').innerText = value.toFixed(2);
				const updates = {};
				updates[name] = value;
				cogLayer.updateStyleVariables(updates);
			});
		}

        const osmMap = new ol.Map({
            target: 'osm-map',
            layers: [baseLayer, vectorLayer],
            view: new ol.View({
                center: ol.proj.fromLonLat([longitude, latitude]),
                zoom: 18,
            }),
        });

        const gdalMap = new ol.Map({
            target: 'gdal-map',
            layers: [cogLayer, vectorLayer],
            view: osmMap.getView(),
        });
		
		const scaleLineControl = new ol.control.ScaleLine();
		gdalMap.addControl(scaleLineControl)
    }
    </script>
</body>
</html>